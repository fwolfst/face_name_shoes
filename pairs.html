<html>
  <head>
    <style>
    :root {
      --header-height: 128px;
      --matched-card-display: inherit;
      padding: 10px;
      font-family: 'Arial';
    }
    header {
      position: fixed;
      inset: 0 0 auto 0;
      height: var(--header-height);
      width: 100%;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      background: white;
      padding-left: 15px;
      padding-right: 15px;
      text-align: center;
      z-index: 100;
    }
    main {
      margin-top: var(--header-height);
      padding: 10px;
      font-family: 'Brush Script MT', cursive;
      font-size: 3rem;
      width: 100%;
    }
    .field {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }
    .card {
      width: 300px;
      min-height: 300px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      text-align: center;
      align-content: center;
      border: 4px solid white;
      border-radius: 10px;
      box-shadow: 1px 1px 6px 6px #CCC;
    }
    .selected {
      border: 4px solid green;
      box-shadow: 2px 2px 14px 14px #AAA;
    }
    .no_match {
      border: 4px solid red;
      box-shadow: 2px 2px 7px 7px #FAA;
    }
    .two_of_three {
      border: 4px solid orange;
      box-shadow: 2px 2px 7px 7px #FFA;
    }
    .checked {
      display: var(--matched-card-display);
      border: 1px solid gray;
      filter: blur(5px) contrast(0.7); /* will blur text too */
    }
    .statrow {
      display: flex;
      justify-content: space-around;
    }
    .stats {
    }
    .state {
      color: green;
      font-size: 14rem;
    }
    .timer {
    }
    </style>
  </head>
  <body>
    <header>
      <h1>Finde die Matches (Name, Portrait, Untenrum)</h1>
      <div class="statrow">
        <div id="stats" class="stats"></div>
        <div id="hider" class="hider">
          <input type="checkbox" id="hide_matched">
          <label for="hide_matched">Fertige ausblenden</label>
        </div>
        <div id="state" class="state"></div>
        <div id="timer" class="timer"></div>
      </div>
    </header>

    <main>
      <div id="field" class="field"></div>
    </main>

    <script>
    function shuffleInPlace(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    let trairs = ['annika_a', 'annika_i', 'chironya', 'christoph_g', 'christoph_s', 'edi', 'fay', 'felix', 'ita', 'jannes', 'jñana', 'joel', 'johanna', 'johannes', 'jörg_r', 'julia_k', 'julian', 'jürgen', 'karina']

    function reset() {
      // TODO shuffle
      // TODO timer
      // TODO missing pairs
      // TODO selection
    }

    // TODO zoom buttons
    // TODO win screen

    let missingPairs = trairs.length;

    let timerSeconds = 0;

    let timerId = setInterval(() => {
      timerSeconds += 1;
      document.getElementById("timer").textContent = timerSeconds + " Sekunden"
    }, 1000);

    let cards = []

    trairs.forEach((name) => {
      // ID, display string, image
      cards.push([name + "_name", name, null])
      cards.push([name + "_portrait", '', name + "_portrait.JPG"])
      cards.push([name + "_shoes", '', name + '_shoes.JPG'])
    })

    shuffleInPlace(cards);

    let selected = new Set();

    cards.forEach(([id, name, bg_image]) => {
      const card = document.createElement('div');
      card.id = id;

      if (name) {
        const name_parts = name.split("_");
        let display_name = name_parts.map(x => x[0].toUpperCase() + x.slice(1, x.length)).join(" ")
        card.textContent = display_name;
      }
      card.classList.add("card");
      card.style.backgroundImage = `url("${bg_image}")`
      card.addEventListener('click', () => {
        card.classList.remove("two_of_three");

        // Toggle selection
        if (selected.has(card)) {
          card.classList.remove("selected");
          selected.delete(card);
          return;
        }

        selected.add(card);
        card.classList.add('selected');
        if (selected.size == 3) {
          Array.from(document.getElementsByClassName("two_of_three")).forEach(e => e.classList.remove("two_of_three"));
          Array.from(document.getElementsByClassName("selected")).forEach(e => e.classList.remove("selected"));
          Array.from(document.getElementsByClassName("no_match")).forEach(e => e.classList.remove("no_match"));
          // selected.forEach(e => e.classList.remove("selected"));

          let names = [...selected].map(i => i.id.slice(0, i.id.lastIndexOf("_")))
          if (new Set(names).size == 1) {
            selected.forEach(e => e.classList.add("checked"));
            selected.forEach(e => (e.onclick = null));
            // TODO remove onclick handler
            // removing click handler doesnt work for whatever reason
            //const clone = el.cloneNode(true);
            //el.replaceWith(clone);

            missingPairs -= 1;

            updateStats();

            if (missingPairs == 0) {
              document.getElementById("state").textContent = "Geschafft nach " + timerSeconds + " Sekunden!"
              clearInterval(timerId);
              // TODO add "replay/reset" button
            }

          } else if (new Set(names).size == 2) {
            //document.getElementById("state").textContent = "Zwei richtige!"
            selected.forEach(e => e.classList.add("two_of_three"));
          } else if (new Set(names).size == 3) {
            selected.forEach(e => e.classList.add("no_match"));
          }

          selected = new Set();
        }
      });

      document.getElementById("field").appendChild(card);
    });

    function updateStats() {
      document.getElementById("stats").textContent = "Noch " + missingPairs + "!";
    }

    document.getElementById("hide_matched").addEventListener('click', (e) => {
      if (e.target.checked) {
        document.documentElement.style.setProperty('--matched-card-display', 'none');
      } else {
        document.documentElement.style.setProperty('--matched-card-display', 'inherit');
      }
    });

    updateStats();

    </script>
  </body>
</html>
